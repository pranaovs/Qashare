#!/usr/bin/env sh

BACKEND_DIR="server/"
DOCS_DIR="${BACKEND_DIR}docs"

if git diff --cached --quiet -- "$BACKEND_DIR"; then
  exit 0
fi

if ! command -v swag >/dev/null 2>&1; then
  echo "::warning::'swag' is not installed. Skipping Swagger check."
  exit 0
fi

TEMP_DIR=$(mktemp -d)

# Ensure cleanup
cleanup() {
  rm -rf "$TEMP_DIR"
}
trap cleanup EXIT

# Generate docs into the TEMP directory
if ! swag init --dir "$BACKEND_DIR" --output "$TEMP_DIR" --quiet; then
  echo "::warning::Failed to generate swagger docs for verification."
  exit 0
fi

# Compare existing docs with the temp docs
if ! diff -r -q "$DOCS_DIR" "$TEMP_DIR" >/dev/null 2>&1; then
  echo "Swagger docs are out of sync!"
  echo "The generated docs differ from what is currently in $DOCS_DIR."
  echo "Run 'swag init' if necessary."
fi

exit 0
